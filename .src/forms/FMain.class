' Gambas class file

Public Sub Form_Resize()

    With pnlToolBar
        .W = Me.ClientW - MMain.MARGIN * 2
        .H = MMain.TLB_HEIGHT
        .Left = MMain.MARGIN
        .Top = 0
    End With

    With wksServers
        .W = Me.ClientW - MMain.MARGIN * 2
        .H = Me.ClientH - pnlToolBar.H - MMain.MARGIN
        .Left = MMain.MARGIN
        .Top = pnlToolBar.H
    End With

End

Public Sub Form_Open()

    Dim i As Integer
    Dim arrStatus As New String[]
    Dim arrName As New String[]
    Dim arrAddress As New String[]
    Dim arrPort As New String[]
    Dim objForm As FSessions

    Message.Title = "Accel GUI"
    arrStatus = Split(MMain.objSettings["Servers/Status"], ";")
    arrName = Split(MMain.objSettings["Servers/Name"], ";")
    arrAddress = Split(MMain.objSettings["Servers/Address"], ";")
    arrPort = Split(MMain.objSettings["Servers/Port"], ";")
    For i = 0 To arrAddress.Max
        If arrStatus[i] = "True" Then
            objForm = New FSessions(arrName[i], arrAddress[i], arrPort[i])
            wksServers.Add(objForm)
        Endif
    Next
    Select Case MMain.strCurrentUser
        Case "admin"
            If User.Id > 0 Then tlbSettings.Enabled = False
        Case "user"
            tlbReload.Enabled = False
            tlbRestart.Enabled = False
            tlbShutdown.Enabled = False
            tlbSettings.Enabled = False
        Case "guest"
            tlbTerminate.Enabled = False
            tlbShaper.Enabled = False
            tlbReload.Enabled = False
            tlbRestart.Enabled = False
            tlbShutdown.Enabled = False
            tlbSettings.Enabled = False
    End Select

End

Public Sub Form_Close()

    triMain.Delete()

End

Public Sub tlbServers_Click()

    FServers.ShowModal()

End

Public Sub tlbSettings_Click()

    FSettings.ShowModal()

End

Public Sub tlbUpdate_Click()

    Dim objWindow As FSessions

    If wksServers.Windows.Count > 0 Then
        objWindow = wksServers.ActiveWindow
        objWindow.grvSessions.Clear()
        objWindow.grvSessions.Rows.Count = 0
        objWindow.objServer.GetSessions()
    Endif

End

Public Sub tlbReload_Click()

    Dim objWindow As FSessions

    If wksServers.Windows.Count > 0 Then
        objWindow = wksServers.ActiveWindow
        If objWindow.objServer.Connected Then
            If Message.Question(("Are you sure to reload config file?"), ("Yes"), ("No")) = 1 Then
                objWindow.objServer.Reload()
            Endif
        Endif
    Endif

End

Public Sub tlbShutdown_Click()

    Dim objWindow As FSessions

    If wksServers.Windows.Count > 0 Then
        objWindow = wksServers.ActiveWindow
        If objWindow.objServer.Connected Then
            FShutdown.ShowModal()
        Endif
    Endif

End

Public Sub tlbFilter_Click()

    Dim objWindow As FSessions

    If wksServers.Windows.Count > 0 Then
        objWindow = wksServers.ActiveWindow
        If objWindow.objServer.Connected Then
            FFilter.ShowModal()
        Endif
    Endif

End

Public Sub wksServers_Activate()

    Dim objWindow As FSessions

    If wksServers.Windows.Count > 0 Then
        objWindow = wksServers.ActiveWindow
        If objWindow.objServer.MatchMode = MColumn.State Then
            tlbFilter.Picture = Picture["images/filteradd.png"]
        Else
            tlbFilter.Picture = Picture["images/filterdel.png"]
        Endif
    Endif

End

Public Sub tlbTerminate_Click()

    Dim objWindow As FSessions
    Dim intRow As Integer
    Dim strName As String

    If wksServers.Windows.Count > 0 Then
        objWindow = wksServers.ActiveWindow
        intRow = objWindow.grvSessions.Row
        If intRow >= 0 Then
            strName = objWindow.grvSessions[intRow, 1].Text
            If Message.Question(("Are you sure to kill session?"), ("Yes"), ("No")) = 1 Then
                objWindow.objServer.KillSession(strName)
            Endif
        Endif
    Endif

End

Public Sub tlbHelp_Click()

    If Exist(MMain.HELPFILE) Then
        FHelp.wwwHelp.Url = "file://" & Application.Path &/ MMain.HELPFILE
        FHelp.ShowModal()
    Else
        Message.Error(("Help file was not found"))
    Endif

End

Public Sub mnuTrayExit_Click()

    Me.Close()

End

Public Sub mnuTrayShow_Click()

    Me.Show()
    triMain.Hide()

End

Public Sub tlbTray_Click()

    Me.Hide()
    triMain.Show()

End

Public Sub triMain_Click()

    mnuTrayShow_Click()

End

Public Sub tlbExit_Click()

    Me.Close()

End
